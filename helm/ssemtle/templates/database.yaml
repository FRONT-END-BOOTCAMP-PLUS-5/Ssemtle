{{- if .Values.database.enabled }}
---
# Secret for old PostgreSQL connection (source for import)
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.database.oldPostgresSecret.name }}
  namespace: {{ .Values.namespace }}
type: Opaque
stringData:
  password: {{ .Values.database.oldPostgresSecret.password | quote }}

---
# CloudNativePG cluster with import
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: {{ .Values.database.name }}
  namespace: {{ .Values.namespace }}
spec:
  instances: {{ .Values.database.instances }}
  imageName: {{ .Values.database.imageName }}

  # Define external clusters (inline)
  externalClusters:
    - name: {{ .Values.database.externalCluster.name }}
      connectionParameters:
        host: {{ .Values.database.externalCluster.host }}
        port: {{ .Values.database.externalCluster.port | quote }}
        user: {{ .Values.database.externalCluster.user }}
        dbname: {{ .Values.database.externalCluster.dbname }}
      password:
        name: {{ .Values.database.oldPostgresSecret.name }}
        key: password

  # Import from old PostgreSQL
  bootstrap:
    initdb:
      database: {{ .Values.database.bootstrap.database }}
      owner: {{ .Values.database.bootstrap.owner }}
      import:
        type: microservice
        databases:
          {{- toYaml .Values.database.bootstrap.importDatabases | nindent 10 }}
        source:
          externalCluster: {{ .Values.database.externalCluster.name }}

  # Storage configuration
  storage:
    size: {{ .Values.database.storage.size }}
    storageClass: {{ .Values.database.storage.storageClass }}

  # Monitoring
  monitoring:
    enablePodMonitor: {{ .Values.database.monitoring.enablePodMonitor }}

  # PostgreSQL configuration
  postgresql:
    parameters:
      {{- toYaml .Values.database.postgresql.parameters | nindent 6 }}

  # Resources
  resources:
    {{- toYaml .Values.database.resources | nindent 4 }}
{{- end }}
